# Plan: AgentGate v0.4

## Objective
Ship **AgentGate v0.4** with production-ready self-hosting and scaling primitives (Docker, PostgreSQL, Redis rate limiting), first-class approval notifications (Email + Discord, improved Slack), one-click approval links, a stronger dashboard UX (audit log page + mobile), and a publishable distribution story (npm packages + docs site + GitHub Action).

## Problem Statement
v0.3 shipped the core product surface (server + dashboard + SDK/CLI + tests + basic rate limiting), but several items block real-world adoption:

- **Self-hosting is incomplete**: Docker compose exists only for Redis; no containerized server/dashboard/DB.
- **Storage is SQLite-only**: fine for dev, but many deployments need PostgreSQL.
- **Rate limiting is in-memory**: breaks on multi-instance deployments.
- **Notifications are missing/incomplete**: no built-in email; no Discord; Slack bot exists but has integration gaps (auth, triggering).
- **Approvals require context switching**: no secure “magic link” style approval from notifications.
- **Dashboard UX**: audit trail is per-request only; mobile nav/table layout needs work; dashboard currently doesn’t attach API key auth headers.
- **Distribution**: SDK/CLI are not ready for publishing (workspace deps, versioning, CLI API mismatch); no docs site.

v0.4 addresses these with minimal new concepts and a clear configuration story.

## Solution Approach

### 1) Core runtime configuration
Introduce a clear, explicit runtime configuration layer (env-driven) across server + integrations:

- `DATABASE_URL` supports:
  - SQLite: file path or `:memory:`
  - PostgreSQL: `postgres://…` / `postgresql://…`
- `REDIS_URL` for Redis-backed rate limiting (and optional token storage if chosen).
- `AGENTGATE_PUBLIC_URL` used to generate externally clickable links.
- Notification/integration config:
  - Email (SMTP): host/port/user/pass/from
  - Slack/Discord: bot tokens + default channel(s)

Document the defaults and provide `.env.example` for compose.

### 2) Database: PostgreSQL alongside SQLite
Add a DB adapter layer in `@agentgate/server`:

- **SQLite stays default for local dev** (no extra services).
- **Postgres supported for production/self-host**.

Implementation approach (Drizzle):
- Split schema into dialect-specific modules:
  - `src/db/schema/sqlite.ts` (current schema)
  - `src/db/schema/postgres.ts` (pg-core equivalents)
- Add `src/db/connection.ts` that:
  - Detects dialect from `DATABASE_URL`
  - Instantiates Drizzle using either `better-sqlite3` or `pg` pool
  - Re-exports `db` + tables under stable names (`approvalRequests`, `auditLogs`, …)
- Migrations:
  - Maintain **two migration folders** (sqlite + postgres) generated by drizzle-kit
  - Add scripts `db:generate:sqlite`, `db:migrate:sqlite`, `db:generate:pg`, `db:migrate:pg`

### 3) Redis-backed rate limiting
Replace the current in-memory-only implementation with a pluggable rate limiter:

- `RateLimiter` interface (async): `check(apiKeyId, limit) => RateLimitResult`
- Implementations:
  - `InMemoryRateLimiter` (existing logic, for tests/dev)
  - `RedisRateLimiter` (sorted-set sliding window)
    - Use Lua script or MULTI pipeline to ensure atomic behavior

Middleware becomes async and chooses implementation based on env:
- `RATE_LIMIT_BACKEND=memory|redis` (default `memory`)
- `REDIS_URL` required when `redis`

### 4) Notification infrastructure (shared across Email/Slack/Discord)
Add a small internal “event → notification” pipeline in the server:

- Emit canonical events:
  - `request.created` (always on creation)
  - `request.pending` (created + pending)
  - `request.approved`, `request.denied`
  - `request.decided` (approved|denied)
  - `request.expired` (when implemented)
- Use policy decision outputs (`channels`, `approvers`) as routing hints.

Routing proposal:
- Interpret `channels` entries as **typed targets**:
  - `slack:#channel` or `slack:C123…`
  - `discord:CHANNEL_ID`
  - `email:user@example.com`
- If no channels specified, fall back to env defaults (`SLACK_DEFAULT_CHANNEL`, `DISCORD_DEFAULT_CHANNEL_ID`, `EMAIL_DEFAULT_TO`).

### 5) One-click approval links (“magic links”)
Provide secure approval links usable from email/Slack/Discord without needing an API key in the client.

Design:
- Add a new table `approval_links` (or `decision_tokens`) storing:
  - `id` (token id)
  - `requestId`
  - `decision` (approved|denied)
  - `expiresAt`
  - `createdAt`
  - `usedAt` (nullable)
  - `metadata` (optional: channel, recipient)
- Token string is `id + signature` (HMAC with server secret) or a random secret stored hashed.

HTTP flow (safe-by-default):
- `GET /l/:token` renders a minimal confirmation page (prevents side effects on email prefetch).
- `POST /l/:token/decide` performs the decision if token is valid + unused + not expired.
- Optionally support “single-click” mode behind a config flag for teams who accept the risk.

These links are included in:
- Email templates (Approve/Deny)
- Slack/Discord messages (link buttons)

### 6) Email notifications
Implement SMTP email notifications for pending approval requests:

- Use `nodemailer`
- HTML + text templates
- Include request summary + parameters/context (truncated) + deep links:
  - View request in dashboard
  - Approve link token
  - Deny link token

### 7) Discord bot (parity with Slack)
Create `@agentgate/discord` package mirroring Slack integration:

- Sends formatted request messages with:
  - action, urgency, request id, created time
  - Approve/Deny buttons
  - View request link
- Handles button interactions:
  - Calls AgentGate decision endpoint using **service API key** OR token-based endpoint
  - Updates original message with decided state

### 8) GitHub Action: CI approval gate
Add a first-party GitHub Action that:

- Creates an approval request with rich context:
  - repo, workflow, run id/url, actor, branch, commit SHA
- Waits/polls until decided (or times out)
- Fails the job on deny/timeout; succeeds on approve
- Exposes outputs: `request_id`, `status`, `decided_by`, `decision_reason`

Implementation options:
- Use `@agentgate/sdk` directly inside the action.
- Bundle with `@vercel/ncc` (standard for Node actions).

### 9) Dashboard UX

#### 9a) Authentication for dashboard API calls
Add a lightweight dashboard “API key session”:
- User enters API key once
- Stored in `localStorage`
- API client attaches `Authorization: Bearer …`
- Add logout/clear key

This unblocks all dashboard pages in secured deployments.

#### 9b) Audit log page + filters
Add a new dashboard page `/audit`:
- Shows audit log entries across all requests
- Filters:
  - event type
  - actor
  - action
  - request id
  - date range
- Pagination

Requires a new server endpoint:
- `GET /api/audit` with query params: `eventType`, `actor`, `action`, `requestId`, `from`, `to`, `limit`, `offset`

#### 9c) Mobile-friendly improvements
- Responsive header nav (hamburger on small screens)
- Replace wide tables with stacked cards on mobile (API keys, requests)
- Modal sizing/scroll fixes
- Make primary actions sticky/obvious on request detail

### 10) Distribution: npm publish + docs

#### 10a) Publishable packages
To publish `@agentgate/sdk` and `@agentgate/cli`, we must also publish `@agentgate/core` (dependency).

- Adopt Changesets for versioning/release
- Ensure package metadata (license, repository, keywords)
- Fix CLI to match server API:
  - list endpoint shape
  - decide endpoint
  - health endpoint

#### 10b) VitePress documentation site
Create a VitePress site:
- Quickstart (dev + docker)
- Config reference (env vars)
- Integrations (Slack/Discord/Email)
- GitHub Action usage examples
- API reference (endpoints + payloads)
- SDK & CLI guides

---

## Relevant Files

### Existing
- `docker-compose.yml` (currently Redis only)
- `packages/server/src/db/index.ts`, `packages/server/src/db/schema.ts`, `packages/server/drizzle.config.ts`
- `packages/server/src/lib/rate-limiter.ts`, `packages/server/src/middleware/auth.ts`
- `packages/server/src/routes/requests.ts`, `packages/server/src/lib/webhook.ts`
- `packages/slack/src/*` (Slack bot)
- `packages/dashboard/src/*` (React dashboard)
- `packages/sdk/src/*`
- `packages/cli/src/*`

### Likely New/Changed
- Server
  - `packages/server/src/db/schema/sqlite.ts`
  - `packages/server/src/db/schema/postgres.ts`
  - `packages/server/src/db/connection.ts`
  - `packages/server/src/lib/rate-limiter/` (interface + backends)
  - `packages/server/src/lib/notifications/` (routing, templates)
  - `packages/server/src/lib/approval-links.ts` + DB table
  - `packages/server/src/routes/audit.ts` (global audit listing)
  - Updated migrations & drizzle configs
- Discord
  - `packages/discord/*`
- GitHub Action
  - `packages/github-action/*` or `./.github/actions/agentgate-approval/*`
- Docs
  - `docs/` (VitePress)
- Root
  - `Dockerfile*`, updated `docker-compose.yml`, `.env.example`

---

## Team Composition

### Team Members
| Name | Role | Agent Type | Purpose |
|------|------|------------|---------|
| builder-db | Builder | prompts/team/builder.md | PostgreSQL support + DB adapter/migrations |
| builder-rate-limit | Builder | prompts/team/builder.md | Redis-backed rate limiter + middleware updates |
| builder-docker | Builder | prompts/team/builder.md | Dockerfiles + compose for self-hosting |
| builder-notify-core | Builder | prompts/team/builder.md | Server eventing + notification routing + approval links |
| builder-email | Builder | prompts/team/builder.md | SMTP email notifications + templates |
| builder-slack | Builder | prompts/team/builder.md | Fix/extend Slack integration (auth + triggers + links) |
| builder-discord | Builder | prompts/team/builder.md | Discord bot package (parity with Slack) |
| builder-dashboard | Builder | prompts/team/builder.md | Dashboard auth + audit page + mobile UX |
| builder-release | Builder | prompts/team/builder.md | Changesets + npm publish (core/sdk/cli) + CLI fixes |
| builder-docs | Builder | prompts/team/builder.md | VitePress docs site |
| builder-gh-action | Builder | prompts/team/builder.md | GitHub Action approval gate |
| validator-backend | Validator | prompts/team/validator.md | Validate server/db/rate-limit/links/notifications |
| validator-frontend | Validator | prompts/team/validator.md | Validate dashboard UX + auth |
| validator-release | Validator | prompts/team/validator.md | Validate publishing + docs build + action packaging |

---

## Task Breakdown

### Task 1: v0.4 config + event naming alignment
- **ID**: `1-config-event-contract`
- **Assigned To**: builder-notify-core
- **Blocked By**: none
- **Parallel**: true
- **Description**:
  - Define env vars for v0.4 (DB/Redis/Public URL/Email/Slack/Discord)
  - Standardize event names (`request.created`, `request.decided`, …) and update docs/spec
  - Decide how policy `channels` routing works (scheme format)
- **Acceptance Criteria**:
  - [ ] `specs/agentgate-v0.4.md` decisions are reflected in a short `docs/config.md` draft or repo notes
  - [ ] Canonical event list agreed and used consistently in code changes

### Task 2: PostgreSQL support (dual-dialect DB adapter)
- **ID**: `2-db-postgres`
- **Assigned To**: builder-db
- **Blocked By**: `1-config-event-contract`
- **Parallel**: true
- **Description**:
  - Add Postgres connection via Drizzle + `pg`
  - Split schema into sqlite/postgres modules
  - Provide migration strategy & scripts
- **Acceptance Criteria**:
  - [ ] Server boots with SQLite by default
  - [ ] Server boots with Postgres when `DATABASE_URL` is postgres
  - [ ] `pnpm --filter @agentgate/server db:migrate:*` works for both dialects

### Task 3: Redis-backed rate limiting
- **ID**: `3-rate-limit-redis`
- **Assigned To**: builder-rate-limit
- **Blocked By**: `1-config-event-contract`
- **Parallel**: true
- **Description**:
  - Introduce async `RateLimiter` interface
  - Keep in-memory backend
  - Add Redis backend using sliding window
  - Update auth middleware + tests
- **Acceptance Criteria**:
  - [ ] With `RATE_LIMIT_BACKEND=redis`, rate limiting works across multiple server instances
  - [ ] Existing headers (`X-RateLimit-*`, `Retry-After`) preserved

### Task 4: Docker + docker-compose self-hosting
- **ID**: `4-docker-compose-selfhost`
- **Assigned To**: builder-docker
- **Blocked By**: `2-db-postgres`
- **Parallel**: true
- **Description**:
  - Add Dockerfiles for server and dashboard (and optional bots)
  - Expand compose to include:
    - server
    - dashboard
    - postgres
    - redis
    - (optional) slack-bot, discord-bot
  - Add `.env.example` and README self-hosting section
- **Acceptance Criteria**:
  - [ ] `docker compose up` brings up a working stack with Postgres + Redis
  - [ ] Clear instructions to bootstrap admin API key + run migrations

### Task 5: Server eventing + notification routing
- **ID**: `5-notify-core`
- **Assigned To**: builder-notify-core
- **Blocked By**: `1-config-event-contract`
- **Parallel**: true
- **Description**:
  - Emit `request.created` always
  - Emit `request.pending` when created and still pending
  - Emit `request.decided`/`request.approved`/`request.denied` on decision
  - Add a notification dispatcher that resolves targets from policy `channels` and defaults
- **Acceptance Criteria**:
  - [ ] Pending requests trigger notification pipeline (even if providers are disabled)
  - [ ] Webhook delivery events remain supported (backward-compatible where possible)

### Task 6: One-click approval link tokens
- **ID**: `6-approval-links`
- **Assigned To**: builder-notify-core
- **Blocked By**: `2-db-postgres`
- **Parallel**: false
- **Description**:
  - Add DB table + server endpoints for token-based approve/deny
  - Render confirmation page + POST decision
  - Include link generation helpers (uses `AGENTGATE_PUBLIC_URL`)
- **Acceptance Criteria**:
  - [ ] Tokens are single-use and expire
  - [ ] Token endpoint can decide a pending request without API key
  - [ ] Audit logs record token-based decisions

### Task 7: Email notifications
- **ID**: `7-email-notifications`
- **Assigned To**: builder-email
- **Blocked By**: `5-notify-core`, `6-approval-links`
- **Parallel**: true
- **Description**:
  - Add SMTP email sender
  - Templates include approve/deny links + view link
  - Configurable recipients via policy channels or defaults
- **Acceptance Criteria**:
  - [ ] In dev, MailHog (or similar) receives emails via compose
  - [ ] Email contains working approval links

### Task 8: Slack integration updates (auth + triggers + links)
- **ID**: `8-slack-notifications`
- **Assigned To**: builder-slack
- **Blocked By**: `5-notify-core`, `6-approval-links`
- **Parallel**: true
- **Description**:
  - Add required AgentGate API key support to Slack bot when calling decision API
  - Add ability for Slack bot to receive “request.pending” notifications (webhook receiver or polling)
  - Include one-click approve/deny links in Slack messages (link buttons)
- **Acceptance Criteria**:
  - [ ] Slack bot can approve/deny successfully against an authenticated AgentGate server
  - [ ] Pending request produces a Slack notification without manual code calling `sendApprovalRequest`

### Task 9: Discord bot package
- **ID**: `9-discord-bot`
- **Assigned To**: builder-discord
- **Blocked By**: `5-notify-core`, `6-approval-links`
- **Parallel**: true
- **Description**:
  - Create `@agentgate/discord`
  - Send pending request notifications
  - Support approve/deny interactions and update message
  - Include one-click approve/deny links
- **Acceptance Criteria**:
  - [ ] Discord bot posts request messages and handles approvals/denials
  - [ ] Security: only intended channel/users can trigger decisions (configurable)

### Task 10: Global audit log API + dashboard page
- **ID**: `10-audit-log-page`
- **Assigned To**: builder-dashboard
- **Blocked By**: `2-db-postgres`
- **Parallel**: true
- **Description**:
  - Add server endpoint `GET /api/audit` with filters + pagination
  - Add dashboard page `/audit` with filter UI
- **Acceptance Criteria**:
  - [ ] Audit page works with large datasets (pagination)
  - [ ] Filters match server behavior

### Task 11: Dashboard auth + mobile-friendly UX
- **ID**: `11-dashboard-auth-mobile`
- **Assigned To**: builder-dashboard
- **Blocked By**: none
- **Parallel**: true
- **Description**:
  - Add API key prompt + localStorage storage
  - Attach Authorization header in dashboard API client
  - Responsive navigation + mobile layouts for tables/modals
- **Acceptance Criteria**:
  - [ ] Dashboard can operate against authenticated server with user-provided API key
  - [ ] Key screens usable on mobile widths (~360px)

### Task 12: GitHub Action approval gate
- **ID**: `12-github-action`
- **Assigned To**: builder-gh-action
- **Blocked By**: none
- **Parallel**: true
- **Description**:
  - Implement Node action that requests approval and waits
  - Provide README usage example + inputs/outputs
- **Acceptance Criteria**:
  - [ ] Action works in a sample workflow and gates a job
  - [ ] Clear timeout/deny behavior

### Task 13: Fix CLI API + align with server
- **ID**: `13-cli-fix`
- **Assigned To**: builder-release
- **Blocked By**: `1-config-event-contract`
- **Parallel**: true
- **Description**:
  - Update CLI endpoints to match server:
    - list response shape
    - decide endpoint
    - health endpoint
  - Consider reusing `@agentgate/sdk` inside CLI for consistency
- **Acceptance Criteria**:
  - [ ] `agentgate list|status|approve|deny|request` work end-to-end against current server

### Task 14: npm publishing setup (core/sdk/cli)
- **ID**: `14-npm-publish`
- **Assigned To**: builder-release
- **Blocked By**: `13-cli-fix`
- **Parallel**: false
- **Description**:
  - Add Changesets
  - Ensure `@agentgate/core`, `@agentgate/sdk`, `@agentgate/cli` are publishable
  - Add CI release workflow (tag → publish)
- **Acceptance Criteria**:
  - [ ] `pnpm changeset version` updates packages correctly
  - [ ] `pnpm -r publish` (or CI) can publish packages publicly

### Task 15: VitePress documentation site
- **ID**: `15-vitepress-docs`
- **Assigned To**: builder-docs
- **Blocked By**: `4-docker-compose-selfhost`, `14-npm-publish`
- **Parallel**: true
- **Description**:
  - Add `docs/` with VitePress config
  - Write guides for docker, postgres, redis rate limiting, notifications, action, sdk/cli
- **Acceptance Criteria**:
  - [ ] `pnpm docs:build` succeeds
  - [ ] Docs cover all v0.4 features at a practical level

### Task 16: Final validation
- **ID**: `16-validate-all`
- **Assigned To**: validator-backend
- **Blocked By**: `2-db-postgres`, `3-rate-limit-redis`, `4-docker-compose-selfhost`, `6-approval-links`, `7-email-notifications`, `8-slack-notifications`, `9-discord-bot`, `10-audit-log-page`, `11-dashboard-auth-mobile`, `12-github-action`, `14-npm-publish`, `15-vitepress-docs`
- **Parallel**: false
- **Description**:
  - Run test suite, typecheck, build
  - Smoke test docker compose stack
  - Validate approval links + email/slack/discord flows
- **Acceptance Criteria**:
  - [ ] All checks pass
  - [ ] A minimal end-to-end demo works: GitHub action creates request → notification → one-click approval → action proceeds

---

## Acceptance Criteria (v0.4)
- **Self-hosting**:
  - [ ] `docker compose up` runs server + dashboard + postgres + redis (and optional bots)
  - [ ] Clear bootstrap/migrate instructions
- **DB**:
  - [ ] Works on SQLite (dev) and PostgreSQL (prod)
- **Rate limiting**:
  - [ ] Redis-backed option works across multiple instances
- **Notifications**:
  - [ ] Email notifications for pending approvals
  - [ ] Discord bot exists and supports approve/deny
  - [ ] Slack integration works with authenticated server
- **One-click links**:
  - [ ] Secure token links exist and are included in email/slack/discord
- **Dashboard**:
  - [ ] Audit log page with filters exists
  - [ ] Dashboard is mobile-friendly and supports API key auth
- **Distribution**:
  - [ ] SDK + CLI (+ core) publishable to npm
  - [ ] VitePress docs site builds
  - [ ] GitHub Action gates a workflow

## Validation Commands
```bash
# from repo root
corepack pnpm install

# backend
pnpm --filter @agentgate/server typecheck
pnpm --filter @agentgate/server test

# full
pnpm typecheck
pnpm test
pnpm build

# docker self-host smoke
docker compose up -d
curl -sSf http://localhost:3000/health

# docs
pnpm docs:build
```

## Notes / Risks
- **Token links & email prefetch**: safest flow is GET confirmation + POST decision. Offer optional “single-click auto-submit” behind a flag if desired.
- **Drizzle dual-dialect**: expect some duplication; keep exported table names stable to minimize server changes.
- **Native deps** (`better-sqlite3`) in docker: prefer Postgres for compose; keep SQLite for local dev.
- **Slack/Discord security**: restrict allowed channels/guilds; use service API key scopes limited to `request:decide`.
